<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Content Editor</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/png" sizes="32x32" href="images/logo.png">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
/* --- General Page & Container Styles --- */
body { 
    padding: 20px; 
    font-family: sans-serif; 
    background-color: #f4f7f6; 
}
#editor-container, #token-modal-container { 
    max-width: 90vw; 
    margin: auto; 
}
#editor-container { 
    background-color: #fff; 
    padding: 20px; 
    border-radius: 8px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
}
label { 
    font-weight: bold; 
    margin-top: 15px; 
    display: block; 
}
select, input[type="text"], input[type="password"], textarea { 
    width: 100%; 
    padding: 10px; 
    margin-bottom: 15px; 
    margin-top: 5px; 
    font-size: 1em; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
    box-sizing: border-box;
}
button {
    width: fit-content; 
    padding: 10px; 
    margin-top: 5px; 
    font-size: 1em; 
    border-radius: 4px; 
    background-color: #2596be; 
    color: white; 
    cursor: pointer; 
    border: none; 
    text-align: center;
    display: block;
    margin-left: auto;
    margin-right: auto;
}
button:disabled { 
    background-color: #a0a0a0; 
}
#status-message { 
    font-weight: bold; 
    padding: 10px; 
    border-radius: 4px; 
    display: none;
    margin: 0; 
}
#latest-markdown {
    padding: 10px;
    background: #f0f0f0;
    border-radius: 4px;
    margin-top: 5px;
    font-family: monospace;
    word-break: break-all;
}
/* Token modal */
#token-overlay { 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background-color: rgba(0,0,0,0.5); 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    z-index: 3000; 
}
#token-modal { 
    background: white; 
    padding: 30px; 
    border-radius: 8px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
    width: 90%; 
    max-width: 500px; 
}
#token-modal h3 { margin-top: 0; }
#token-modal button { padding: 10px; margin-top: 15px; background: #28a745; }
/* Layout */
.editor-grid { 
    display: grid; 
    grid-template-columns: 5fr 1fr; 
    gap: 25px; 
    align-items: start; 
}
.main-editor { 
    display: flex; 
    flex-direction: column; 
    height: calc(100vh - 100px); 
}
.editor-preview-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 15px; 
    flex-grow: 1; 
    min-height: 0; 
}
.editor-pane, .preview-pane { 
    display: flex; 
    flex-direction: column; 
    min-height: 0; 
}
#editor-content, #preview-content { 
    flex-grow: 1; 
    min-height: 0; 
    overflow-y: auto; 
    border: 1px solid #ccc; 
    padding: 10px; 
    margin-top: 5px; 
    font-family: monospace; 
    font-size: 14px; 
}
#preview-content { 
    background-color: #fafafa; 
    font-family: sans-serif; 
}
#preview-content img {
    max-width: 100%;
}
.editor-footer {
    flex-shrink: 0;
    padding-top: 15px;
}
.home-link {
    width: fit-content;
    margin: 15px auto 0 auto;
    padding: 10px 20px;
    background-color: #6c757d;
    color: white;
    border-radius: 4px;
    text-decoration: none;
    display: block;
    text-align: center;
}
/* Cheatsheet & Save */
.cheatsheet { 
    background-color: #f8f9fa; 
    border: 1px solid #dee2e6; 
    border-radius: 4px; 
    padding: 15px; 
    font-size: 0.9em; 
    position: sticky; 
    top: 20px; 
    max-height: 80vh;
    overflow-y: auto;
}
.cheatsheet h4 { 
    margin-top: 0; 
    border-bottom: 1px solid #ccc; 
    padding-bottom: 8px; 
}
.cheatsheet code { 
    background-color: #e9ecef; 
    padding: 2px 5px; 
    border-radius: 3px; 
    font-family: monospace; 
}
#user-name {
  width: 50%;          
  margin-top: 2px;
  margin-left: 0;
  margin-right: auto;
}
</style>
</head>
<body>

<div id="token-overlay" style="display: none;">
    <div id="token-modal">
        <h2>GitHub Access Token Required</h2>
        <p>Because this page is hosted on GitHub, changing content requires a GitHub account. Using the support account's GitHub credentials and token, you can update contents as if you were logged in.<br><br></p>
        <p>Because of this, you need to provide a GitHub access token to unlock the editor. Search for 'SupportPage GitHub Token Clearly' on 1Password to get the token.</p>
        <input type="password" id="pat-input" placeholder="Paste your token here..." form="none">
        <button id="pat-submit">Unlock Editor</button>
    </div>
</div>

<div id="editor-container" style="display: none;">
    <h2>Page Content Editor</h2>
    <div class="editor-grid">
        <div class="main-editor">
            <div>
                <label for="file-selector">Choose a file to edit:</label>
                <select id="file-selector">
                    <option value="content/en/projects/versions.md">Projects - Versions (English)</option>
                    <option value="content/nl/projects/versions.md">Projects - Versions (Dutch)</option>
                    <option value="content/en/projects/faq.md">Projects - FAQ (English)</option>
                    <option value="content/nl/projects/faq.md">Projects - FAQ (Dutch)</option>
                    <option value="content/en/3d/versions.md">3D - Versions (English)</option>
                    <option value="content/nl/3d/versions.md">3D - Versions (Dutch)</option>
                    <option value="content/en/3d/faq.md">3D - FAQ (English)</option>
                    <option value="content/nl/3d/faq.md">3D - FAQ (Dutch)</option>
                    <option value="content/en/bim/versions.md">BIM - Versions (English)</option>
                    <option value="content/nl/bim/versions.md">BIM - Versions (Dutch)</option>
                    <option value="content/en/bim/faq.md">BIM - FAQ (English)</option>
                    <option value="content/nl/bim/faq.md">BIM - FAQ (Dutch)</option>
                    <option value="content/en/hub/versions.md">Hub - Versions (English)</option>
                    <option value="content/nl/hub/versions.md">Hub - Versions (Dutch)</option>
                    <option value="content/en/hub/faq.md">Hub - FAQ (English)</option>
                    <option value="content/nl/hub/faq.md">Hub - FAQ (Dutch)</option>
                </select>
            </div>
            <div class="editor-preview-grid">
                <div class="editor-pane">
                    <button type="button" id="upload-image-button">Upload Image</button>
                    <input type="file" id="image-uploader" accept="image/*" style="display: none;">
                    <div>Latest Uploaded Image:</div>
                    <div id="latest-markdown">None</div>
                    <label for="editor-content">File Content (Markdown):</label>
                    <textarea id="editor-content" placeholder="Loading file content..."></textarea>
                </div>
                <div class="preview-pane">
                    <label for="preview-content">Live Preview:</label>
                    <div id="preview-content" class="markdown-container"></div>
                </div>
            </div>
            <div class="editor-footer">
                <div id="status-message"></div>
                <label for="user-name">Your Name (for commit message):</label>
                <input type="text" id="user-name" placeholder="Enter your name...">
                <button type="button" id="save-button">Save Changes</button>
                <a class="home-link" href="index.html">← Back to Home Page</a>
            </div>
        </div>

        <div class="cheatsheet">
            <h4>Markdown Cheatsheet</h4>
            <p><strong>Headers:</strong><br>
            <code># H1</code><br>
            <code>## H2</code><br>
            <code>### H3</code></p>
            <p><strong>Emphasis:</strong><br>
            <code>*italic*</code> or <code>_italic_</code><br>
            <code>**bold**</code> or <code>__bold__</code><br>
            <code>~~strikethrough~~</code></p>
            <p><strong>Lists:</strong><br>
            <strong>Bulleted:</strong><br>
            <code>- Item 1</code><br>
            <code>- Item 2</code><br>
            <strong>Numbered:</strong><br>
            <code>1. Item 1</code><br>
            <code>2. Item 2</code></p>
            <p><strong>Nested Lists:</strong><br>
            <code>- Item 1<br>&nbsp;&nbsp;- Subitem 1<br>- Item 2</code></p>
            <p><strong>Links:</strong><br>
            <code>[Link text](https://example.com)</code></p>
            <p><strong>Images:</strong><br>
            <code>![Alt text](image-url)</code><br>
            <p><strong>Blockquotes:</strong><br>
            <code>> This is a quote</code></p>
            <p><strong>Inline code:</strong><br>
            <code>`inline code`</code></p>
            <p><strong>Code blocks:</strong><br>
            <code>```<br>function test() {<br>  console.log("Hello");<br>}<br>```</code></p>
            <p><strong>Horizontal Rule:</strong><br>
            <code>---</code></p>
            <p><strong>Tables:</strong><br>
            <code>| Header 1 | Header 2 |<br>| --- | --- |<br>| Row 1 Col1 | Row1 Col2 |</code></p>
            <p><strong>Task Lists:</strong><br>
            <code>- [ ] Incomplete item<br>- [x] Completed item</code></p>
            <p><strong>Latest Uploaded Image:</strong><br>
            <div id="latest-markdown" style="background:#e9ecef; padding:5px; border-radius:3px; font-family:monospace;">(No image uploaded yet)</div></p>
        </div>
    </div>
</div>

<script type="module">
import { Octokit } from "https://esm.sh/octokit";
import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

const ADMIN_EMAIL = "support@futureinsight.nl";
const GITHUB_OWNER = "fi-group";
const GITHUB_REPO = "clearly-support-page";
const GITHUB_BRANCH = "main";

let octokit;

function decodeJwt(token) {
  try {
    const base64Url = token.split(".")[1];
    const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
    const jsonPayload = decodeURIComponent(
      atob(base64).split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join("")
    );
    return JSON.parse(jsonPayload);
  } catch (e) { return null; }
}

function isUserAdmin() {
  const idToken = localStorage.getItem("idToken");
  if (!idToken) return false;
  const decodedToken = decodeJwt(idToken);
  return decodedToken && decodedToken.email === ADMIN_EMAIL;
}

document.addEventListener("DOMContentLoaded", () => {
    const editorContainer = document.getElementById("editor-container");
    const tokenOverlay = document.getElementById("token-overlay");
    const patInput = document.getElementById("pat-input");
    const patSubmit = document.getElementById("pat-submit");
    const selector = document.getElementById("file-selector");
    const editor = document.getElementById("editor-content");
    const saveButton = document.getElementById("save-button");
    const statusMessage = document.getElementById("status-message");
    const previewArea = document.getElementById("preview-content");
    const uploadButton = document.getElementById("upload-image-button");
    const imageUploader = document.getElementById("image-uploader");
    const latestMarkdown = document.getElementById("latest-markdown");
    const userNameInput = document.getElementById("user-name");

    function unlockEditor() {
        tokenOverlay.style.display = "none";
        editorContainer.style.display = "block";
        loadFile(selector.value);
    }

    function handleTokenSubmit() {
        const pat = patInput.value.trim();
        if (pat && pat.startsWith("ghp_")) {
            sessionStorage.setItem("github_pat", pat);
            octokit = new Octokit({ auth: pat });
            unlockEditor();
        } else {
            alert("Please enter a valid GitHub Personal Access Token.");
        }
    }

    patSubmit.addEventListener("click", handleTokenSubmit);

    const storedPat = sessionStorage.getItem("github_pat");
    if (storedPat) {
        octokit = new Octokit({ auth: storedPat });
        unlockEditor();
    } else {
        tokenOverlay.style.display = "flex";
    }

    function updatePreview() {
        previewArea.innerHTML = marked.parse(editor.value);
    }

    async function loadFile(filePath) {
    editor.value = "Loading...";
    statusMessage.style.display = "none";
    try {
        const { data } = await octokit.rest.repos.getContent({
        owner: GITHUB_OWNER,
        repo: GITHUB_REPO,
        path: filePath,
        ref: GITHUB_BRANCH,
        });
        editor.value = atob(data.content);
        updatePreview();
    } catch (error) {
        editor.value = `Error loading file: ${error.message}`;
        console.error(error);
    }
    }

    async function uploadImage(fileName, fileContentBase64) {
        statusMessage.style.display = "block";
        statusMessage.textContent = "Uploading image...";
        uploadButton.disabled = true;

        try {
            const filePath = `images/${fileName}`;
            let sha;

            // Check if file exists to get its SHA
            try {
            const { data } = await octokit.rest.repos.getContent({
                owner: GITHUB_OWNER,
                repo: GITHUB_REPO,
                path: filePath,
                ref: GITHUB_BRANCH,
            });
            sha = data.sha; // file exists, set SHA
            } catch (err) {
            if (err.status !== 404) throw err; // if error is not "file not found", throw
            sha = undefined; // new file, no SHA needed
            }

            await octokit.rest.repos.createOrUpdateFileContents({
            owner: GITHUB_OWNER,
            repo: GITHUB_REPO,
            path: filePath,
            message: `feat: Add image ${fileName}`,
            content: fileContentBase64,
            sha, // include only if file exists
            branch: GITHUB_BRANCH,
        });

    const markdownText = `![${fileName}](https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/images/${fileName})`;
    latestMarkdown.textContent = markdownText;

    statusMessage.textContent = "✅ Image uploaded successfully! Copy the Markdown from above.";
    statusMessage.style.color = "green";

  } catch (error) {
    console.error(error);
    statusMessage.textContent = `❌ Error uploading image: ${error.message}`;
    statusMessage.style.color = "red";
  } finally {
    uploadButton.disabled = false;
  }
}


  async function saveFile() {
    const userName = userNameInput.value.trim();
    if (!userName) {
        statusMessage.style.display = "block";
        statusMessage.textContent = "❌ Please enter your name to save changes.";
        statusMessage.style.color = "red";
        userNameInput.focus(); // Puts the cursor in the name box
        return; 
    }
    // Validation passed
    saveButton.disabled = true;
    statusMessage.style.display = "block";
    statusMessage.textContent = "Saving...";
    statusMessage.style.color = "inherit"; // Resets color from potential red error
    const filePath = selector.value;

    // Save the name to local storage
    localStorage.setItem("editor_user_name", userName);

    // Create the commit message 
    const commitMessage = `${userName}: Updated content from web editor`;

    try {
      let { data: fileData } = await octokit.rest.repos.getContent({
        owner: GITHUB_OWNER,
        repo: GITHUB_REPO,
        path: filePath,
        ref: GITHUB_BRANCH,
      });

      const contentEncoded = btoa(unescape(encodeURIComponent(editor.value)));

      try {
        await octokit.rest.repos.createOrUpdateFileContents({
          owner: GITHUB_OWNER,
          repo: GITHUB_REPO,
          path: filePath,
          message: commitMessage,
          content: contentEncoded,
          sha: fileData.sha,
          branch: GITHUB_BRANCH,
        });
      } catch (err) {
        if (err.status === 409) { // SHA mismatch
          const { data: latestData } = await octokit.rest.repos.getContent({
            owner: GITHUB_OWNER,
            repo: GITHUB_REPO,
            path: filePath,
            ref: GITHUB_BRANCH,
          });
          await octokit.rest.repos.createOrUpdateFileContents({
            owner: GITHUB_OWNER,
            repo: GITHUB_REPO,
            path: filePath,
            message: commitMessage,
            content: contentEncoded,
            sha: latestData.sha,
            branch: GITHUB_BRANCH,
          });
        } else {
          throw err;
        }
      }

      statusMessage.textContent = "✅ File saved successfully! It will take 1-2 minutes to rebuild the site again with the new content.";
      statusMessage.style.color = "green";
      setTimeout(() => loadFile(filePath), 6000);

    } catch (error) {
      console.error(error);
      statusMessage.textContent = `❌ Error saving file: ${error.message}`;
      statusMessage.style.color = "red";
    } finally {
      saveButton.disabled = false;
    }
  }

  const storedName = localStorage.getItem("editor_user_name");
    if (storedName) {
        userNameInput.value = storedName;
    }
  uploadButton.addEventListener("click", () => imageUploader.click());
  imageUploader.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => uploadImage(file.name, e.target.result.split(",")[1]);
    reader.readAsDataURL(file);
    event.target.value = "";
  });

  editor.addEventListener("paste", (event) => {
    const items = event.clipboardData?.items || event.originalEvent.clipboardData?.items;
    for (const item of items) {
      if (item.kind === "file" && item.type.startsWith("image/")) {
        event.preventDefault();
        const imageFile = item.getAsFile();
        const reader = new FileReader();
        reader.onload = (e) => {
          const fileExtension = imageFile.type.split("/")[1];
          const fileName = `pasted-image-${Date.now()}.${fileExtension}`;
          uploadImage(fileName, e.target.result.split(",")[1]);
        };
        reader.readAsDataURL(imageFile);
        return;
      }
    }
  });

  editor.addEventListener("input", updatePreview);
  selector.addEventListener("change", () => loadFile(selector.value));
  saveButton.addEventListener("click", saveFile);
});
</script>
</body>
</html>
